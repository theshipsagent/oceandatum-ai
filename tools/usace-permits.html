<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USACE Public Notices Search Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            padding: 80px 20px 20px;
            color: rgba(255,255,255,0.9);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, rgba(0,0,0,0.5) 0%, rgba(26,26,46,0.6) 100%);
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid rgba(100,255,180,0.2);
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

        .header p {
            font-size: 1.05em;
            color: rgba(255,255,255,0.6);
            font-weight: 300;
        }

        .controls {
            padding: 30px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 15px;
            color: rgba(255,255,255,0.7);
            letter-spacing: 0.02em;
        }

        .district-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .district-checkbox {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.25s ease;
            color: rgba(255,255,255,0.8);
            font-size: 0.95em;
        }

        .district-checkbox:hover {
            border-color: rgba(100,255,180,0.4);
            background: rgba(100,255,180,0.06);
        }

        .district-checkbox input {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #64ffb4;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 10px 22px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.25s ease;
        }

        .btn-primary {
            background: #64ffb4;
            color: #0a0a0a;
        }

        .btn-primary:hover {
            background: #52e6a0;
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(100, 255, 180, 0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.12);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.9);
            border-color: rgba(255,255,255,0.2);
        }

        .btn-success {
            background: rgba(100,255,180,0.12);
            color: #64ffb4;
            border: 1px solid rgba(100,255,180,0.25);
        }

        .btn-success:hover {
            background: rgba(100,255,180,0.18);
            border-color: rgba(100,255,180,0.4);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 10px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 6px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.95em;
            color: #fff;
        }

        .search-box input::placeholder {
            color: rgba(255,255,255,0.35);
        }

        .search-box input:focus {
            outline: none;
            border-color: rgba(100,255,180,0.5);
            box-shadow: 0 0 0 2px rgba(100,255,180,0.1);
        }

        .stats {
            padding: 18px 30px;
            background: rgba(100,255,180,0.04);
            border-bottom: 1px solid rgba(100,255,180,0.1);
            display: none;
            justify-content: space-around;
            align-items: center;
        }

        .stats-item {
            text-align: center;
        }

        .stats-number {
            font-size: 1.8em;
            font-weight: 600;
            color: #64ffb4;
        }

        .stats-label {
            color: rgba(255,255,255,0.45);
            font-size: 0.85em;
            font-weight: 300;
        }

        .results {
            padding: 30px;
            max-height: 600px;
            overflow-y: auto;
        }

        .permit-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.25s ease;
        }

        .permit-card:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.14);
            transform: translateY(-1px);
        }

        .permit-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .permit-number {
            font-size: 1.1em;
            font-weight: 600;
            color: #fff;
        }

        .district-badge {
            background: rgba(100,255,180,0.15);
            color: #64ffb4;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 500;
            border: 1px solid rgba(100,255,180,0.25);
        }

        .permit-description {
            color: rgba(255,255,255,0.6);
            line-height: 1.6;
            margin: 10px 0;
            font-size: 0.92em;
        }

        .permit-date {
            color: rgba(255,255,255,0.35);
            font-size: 0.85em;
            margin-top: 10px;
        }

        .permit-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .permit-actions button {
            padding: 7px 14px;
            font-size: 0.85em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.5);
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.08);
            border-top: 3px solid #64ffb4;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 14px 16px;
            margin: 20px 0 0;
            border-radius: 6px;
            background: rgba(255,193,7,0.08);
            border: 1px solid rgba(255,193,7,0.2);
            color: rgba(255,193,7,0.85);
            font-size: 0.9em;
            text-align: left;
        }

        .alert strong {
            color: rgba(255,193,7,0.95);
        }

        .error-msg {
            padding: 10px 14px;
            margin: 8px 0;
            border-radius: 6px;
            background: rgba(255,100,100,0.08);
            border: 1px solid rgba(255,100,100,0.2);
            color: rgba(255,100,100,0.8);
            font-size: 0.85em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.6em;
            }

            .district-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
<style id="sn-css">
.sn{position:fixed;top:0;left:0;right:0;z-index:2000;background:rgba(10,10,10,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(100,255,180,0.12);padding:0 1.5rem;height:48px;display:flex;align-items:center;justify-content:space-between;font-family:'Space Grotesk',sans-serif}
.sn a{font-size:0.82rem;color:rgba(255,255,255,0.5);text-decoration:none;white-space:nowrap;transition:color 0.2s}
.sn a:hover{color:#64ffb4}
.sn-r{display:flex;gap:1.2rem;align-items:center}
.sn-hub{padding:0.25rem 0.7rem;border:1px solid rgba(255,255,255,0.12);border-radius:5px}
.sn-hub:hover{border-color:rgba(100,255,180,0.3)}
.sn-logout{color:rgba(255,100,100,0.7)!important;padding:0.25rem 0.7rem;border:1px solid rgba(255,100,100,0.2);border-radius:5px}
.sn-logout:hover{color:#ff6464!important;border-color:rgba(255,100,100,0.4)}
@media(max-width:480px){.sn{padding:0 0.75rem;height:42px}.sn a{font-size:0.72rem}.sn-r{gap:0.6rem}}
</style>
</head>
<body>
<script>if("scrollRestoration"in history)history.scrollRestoration="manual";window.scrollTo(0,0);</script>
    <nav class="sn">
  <a href="../index.html">Home</a>
  <div class="sn-r">
    <a href="maritime-ai-role.html">Role Brief</a>
    <a href="../cv.html">CV</a>
    <a href="../projects-hub.html" class="sn-hub">&larr; Hub</a>
  </div>
</nav>

    <div class="container">
        <div class="header">
            <h1>USACE Public Notices Search</h1>
            <p>Search Permits Across Multiple Districts</p>
        </div>

        <div class="controls">
            <div class="section-title">Select USACE Districts:</div>
            <div class="district-grid" id="districtGrid"></div>

            <div class="button-group">
                <button class="btn-primary" onclick="fetchPermits()">Fetch Permits</button>
                <button class="btn-secondary" onclick="selectAll()">Select All</button>
                <button class="btn-secondary" onclick="deselectAll()">Deselect All</button>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by keyword (e.g., barge, dredge, parish name)..." onkeypress="handleSearchKey(event)">
                <button class="btn-primary" onclick="searchPermits()">Search</button>
            </div>

            <div class="button-group" style="margin-top: 15px;">
                <button class="btn-success" onclick="exportCSV()">Download CSV</button>
                <button class="btn-success" onclick="exportTable()">Download Table</button>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stats-item">
                <div class="stats-number" id="totalCount">0</div>
                <div class="stats-label">Total Permits</div>
            </div>
            <div class="stats-item">
                <div class="stats-number" id="districtCount">0</div>
                <div class="stats-label">Districts</div>
            </div>
            <div class="stats-item">
                <div class="stats-number" id="filteredCount">0</div>
                <div class="stats-label">Showing</div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="loading">
                <p>Select districts and click "Fetch Permits" to begin</p>
                <div class="alert">
                    <strong>Note:</strong> This tool fetches data directly from USACE RSS feeds.
                    Some districts may take 10-30 seconds to load. If a district fails to load,
                    it may have CORS restrictions — try selecting different districts.
                </div>
            </div>
        </div>
    </div>

    <script>
        // USACE District RSS Feeds
        const DISTRICTS = {
            'New Orleans': 'https://www.mvn.usace.army.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=4&Site=417&max=500',
            'Mobile': 'https://www.sam.usace.army.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=1&Site=392&max=500',
            'Vicksburg': 'https://www.mvk.usace.army.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=1&Site=489&max=500',
            'Galveston': 'https://www.swg.usace.army.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=1&Site=463&max=500',
            'Jacksonville': 'https://www.saj.usace.army.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=1&Site=426&max=500',
            'Charleston': 'https://www.sac.usace.army.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=1&Site=384&max=500',
            'Wilmington': 'https://www.saw.usace.army.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=1&Site=495&max=500',
            'Norfolk': 'https://www.nao.usace.army.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=1&Site=240&max=500',
        };

        let allPermits = [];
        let filteredPermits = [];
        let fetchErrors = [];

        // Initialize districts
        function initDistricts() {
            const grid = document.getElementById('districtGrid');
            Object.keys(DISTRICTS).forEach(district => {
                const label = document.createElement('label');
                label.className = 'district-checkbox';
                label.innerHTML = `
                    <input type="checkbox" value="${district}" checked>
                    <span>${district}</span>
                `;
                grid.appendChild(label);
            });
        }

        function selectAll() {
            document.querySelectorAll('.district-checkbox input').forEach(cb => cb.checked = true);
        }

        function deselectAll() {
            document.querySelectorAll('.district-checkbox input').forEach(cb => cb.checked = false);
        }

        function handleSearchKey(event) {
            if (event.key === 'Enter') {
                searchPermits();
            }
        }

        // CORS proxies — try allorigins first, fall back to corsproxy.io
        const CORS_PRIMARY = 'https://api.allorigins.win/raw?url=';
        const CORS_FALLBACK = 'https://corsproxy.io/?';

        async function fetchWithProxy(url) {
            // Try primary proxy
            try {
                const resp = await fetch(CORS_PRIMARY + encodeURIComponent(url));
                if (resp.ok) return await resp.text();
            } catch (e) { /* fall through */ }

            // Try fallback proxy
            const resp = await fetch(CORS_FALLBACK + encodeURIComponent(url));
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            return await resp.text();
        }

        async function fetchDistrictPermits(districtName, rssUrl) {
            try {
                const text = await fetchWithProxy(rssUrl);
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');

                // Check for XML parse errors
                if (xml.querySelector('parsererror')) {
                    throw new Error('Invalid XML response');
                }

                const items = xml.querySelectorAll('item');
                const permits = [];

                items.forEach(item => {
                    const title = item.querySelector('title')?.textContent || '';
                    const link = item.querySelector('link')?.textContent || '';
                    const description = item.querySelector('description')?.textContent || '';
                    const pubDate = item.querySelector('pubDate')?.textContent || '';

                    // Clean description
                    let cleanDesc = description.replace(/<[^>]+>/g, '');
                    cleanDesc = cleanDesc.replace(/Expiration date:.*?\n?/g, '').trim();

                    permits.push({
                        district: districtName,
                        permitNumber: title.trim(),
                        publicationDate: pubDate,
                        description: cleanDesc,
                        detailUrl: link
                    });
                });

                return permits;
            } catch (error) {
                console.error(`Error fetching ${districtName}:`, error);
                fetchErrors.push({ district: districtName, error: error.message });
                return [];
            }
        }

        async function fetchPermits() {
            const checkboxes = document.querySelectorAll('.district-checkbox input:checked');
            const selectedDistricts = Array.from(checkboxes).map(cb => cb.value);

            if (selectedDistricts.length === 0) {
                alert('Please select at least one district');
                return;
            }

            document.getElementById('results').innerHTML = '<div class="loading"><div class="spinner"></div><p>Fetching permits from selected districts...<br><small>This may take 10-30 seconds</small></p></div>';
            document.getElementById('stats').style.display = 'none';

            allPermits = [];
            fetchErrors = [];

            // Fetch from each district
            for (const district of selectedDistricts) {
                const permits = await fetchDistrictPermits(district, DISTRICTS[district]);
                allPermits = allPermits.concat(permits);

                // Update progress
                document.getElementById('results').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loaded ${allPermits.length} permits from ${district}...</p>
                    </div>
                `;
            }

            filteredPermits = allPermits;
            displayPermits(filteredPermits);
            updateStats();
        }

        function searchPermits() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();

            if (!keyword) {
                filteredPermits = allPermits;
            } else {
                filteredPermits = allPermits.filter(p =>
                    p.description.toLowerCase().includes(keyword) ||
                    p.permitNumber.toLowerCase().includes(keyword)
                );
            }

            displayPermits(filteredPermits);
            updateStats();
        }

        function displayPermits(permits) {
            const resultsDiv = document.getElementById('results');
            let html = '';

            // Show errors if any
            if (fetchErrors.length > 0) {
                fetchErrors.forEach(err => {
                    html += `<div class="error-msg">${err.district} — failed to load: ${err.error}</div>`;
                });
            }

            if (permits.length === 0 && fetchErrors.length === 0) {
                resultsDiv.innerHTML = '<div class="loading"><p>No permits found</p></div>';
                return;
            }

            permits.forEach(permit => {
                const shortDesc = permit.description.length > 300
                    ? permit.description.substring(0, 300) + '...'
                    : permit.description;

                html += `
                    <div class="permit-card">
                        <div class="permit-header">
                            <div class="permit-number">${permit.permitNumber}</div>
                            <div class="district-badge">${permit.district}</div>
                        </div>
                        <div class="permit-description">${shortDesc}</div>
                        <div class="permit-date">${permit.publicationDate}</div>
                        <div class="permit-actions">
                            <button class="btn-primary" onclick="window.open('${permit.detailUrl}', '_blank')">View Details</button>
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        function updateStats() {
            const selectedDistricts = new Set(filteredPermits.map(p => p.district));
            document.getElementById('totalCount').textContent = allPermits.length;
            document.getElementById('districtCount').textContent = selectedDistricts.size;
            document.getElementById('filteredCount').textContent = filteredPermits.length;
            document.getElementById('stats').style.display = 'flex';
        }

        function exportCSV() {
            if (filteredPermits.length === 0) {
                alert('No permits to export');
                return;
            }

            let csv = 'District,Permit Number,Publication Date,Description,Detail URL\n';

            filteredPermits.forEach(permit => {
                const desc = permit.description.replace(/"/g, '""');
                csv += `"${permit.district}","${permit.permitNumber}","${permit.publicationDate}","${desc}","${permit.detailUrl}"\n`;
            });

            downloadFile(csv, 'usace_permits_' + new Date().toISOString().slice(0,10) + '.csv', 'text/csv');
        }

        function exportTable() {
            if (filteredPermits.length === 0) {
                alert('No permits to export');
                return;
            }

            let html = `<!DOCTYPE html>
<html>
<head>
    <title>USACE Permits Export</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #1a1a2e; color: #64ffb4; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        a { color: #1a1a2e; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>USACE Public Notices Export</h1>
    <p>Generated: ${new Date().toLocaleString()}</p>
    <p>Total Permits: ${filteredPermits.length}</p>
    <table>
        <thead>
            <tr>
                <th>District</th>
                <th>Permit Number</th>
                <th>Date</th>
                <th>Description</th>
                <th>Link</th>
            </tr>
        </thead>
        <tbody>`;

            filteredPermits.forEach(permit => {
                html += `
            <tr>
                <td>${permit.district}</td>
                <td>${permit.permitNumber}</td>
                <td>${permit.publicationDate}</td>
                <td>${permit.description}</td>
                <td><a href="${permit.detailUrl}" target="_blank">View</a></td>
            </tr>`;
            });

            html += `
        </tbody>
    </table>
</body>
</html>`;

            downloadFile(html, 'usace_permits_' + new Date().toISOString().slice(0,10) + '.html', 'text/html');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        }

        // Initialize on page load
        initDistricts();
    </script>
</body>
</html>
